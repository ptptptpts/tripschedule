<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공유 가능한 인터랙티브 세부 가족 여행 가이드 (보안 오류 수정)</title>
    <!-- Chosen Palette: Serene Coast -->
    <!-- Application Structure Plan: The application is a task-oriented dashboard with a key improvement: a real-time collaborative checklist powered by Firebase. A unique 'Trip ID' is generated and used in a shareable URL, allowing multiple users to view and edit the same checklist simultaneously. This directly addresses the user's need for a shared planning tool. The structure remains user-centric (Preparation, Activities, etc.), but the 'Preparation' section is now a dynamic, multi-user component, significantly enhancing its utility for a couple planning a trip together. -->
    <!-- Visualization & Content Choices: 
        - Collaborative Checklist -> Goal: Organize/Collaborate -> Viz: Interactive HTML checklist with real-time updates -> Justification: Enables two or more users to manage a single source of truth for packing, solving the core user request. The visual feedback of seeing a partner's updates in real-time is highly engaging and practical. -> Method: Vanilla JS, Firebase Firestore, HTML/CSS.
        - eTravel/Delivery Process -> Goal: Organize -> Viz: HTML/CSS Flowchart -> Justification: Simple, visual step-by-step guides remain the most intuitive method. -> Method: HTML/CSS.
        - Payment/Transport Charts -> Goal: Inform/Compare -> Viz: Chart.js Doughnut/Bar Charts -> Justification: These static charts still provide the best at-a-glance comparison and breakdown of information. -> Library: Chart.js/Canvas.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F7F4; }
        .text-brand-dark { color: #2C3E50; } .bg-brand-dark { background-color: #2C3E50; }
        .text-brand-primary { color: #3498DB; } .bg-brand-primary { background-color: #3498DB; }
        .text-brand-secondary { color: #5DADE2; } .bg-brand-secondary { background-color: #5DADE2; }
        .text-brand-accent { color: #E67E22; } .bg-brand-accent { background-color: #E67E22; }
        .bg-brand-light { background-color: #ECF0F1; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 280px; max-height: 350px; }
        .nav-link.active { color: #E67E22; border-bottom-color: #E67E22; }
        .tab-button.active { background-color: #3498DB; color: white; }
        .checklist-item.checked label { text-decoration: line-through; color: #95a5a6; }
        #share-url { -webkit-user-select: all; user-select: all; }
    </style>
</head>
<body class="text-brand-dark">

    <header class="p-4 md:p-6 bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-brand-primary">세부 가족여행 플래너</h1>
            <nav id="main-nav" class="hidden md:flex space-x-6">
                <a href="#prep" class="nav-link font-semibold pb-1 border-b-2 border-transparent hover:text-brand-accent">준비</a>
                <a href="#activities" class="nav-link font-semibold pb-1 border-b-2 border-transparent hover:text-brand-accent">즐길거리</a>
                <a href="#dining" class="nav-link font-semibold pb-1 border-b-2 border-transparent hover:text-brand-accent">먹거리</a>
                <a href="#safety" class="nav-link font-semibold pb-1 border-b-2 border-transparent hover:text-brand-accent">안전</a>
                <a href="#itinerary" class="nav-link font-semibold pb-1 border-b-2 border-transparent hover:text-brand-accent">일정</a>
            </nav>
        </div>
    </header>

    <div class="bg-brand-primary text-white text-center py-12 px-4">
        <h2 class="text-3xl md:text-4xl font-bold">19개월 아기와 함께하는 샹그릴라 막탄</h2>
        <p class="mt-2 text-lg">실시간으로 함께 준비하고, 완벽한 휴가를 만드세요.</p>
    </div>

    <main class="container mx-auto p-4 md:p-8">

        <section id="prep" class="mb-16 scroll-mt-24">
            <h3 class="text-3xl font-bold text-center mb-2">여행 준비 대시보드</h3>
            <p class="text-center text-gray-600 mb-8">체크리스트를 공유하고 함께 준비 상황을 확인하세요.</p>
            
            <div id="share-section" class="mb-8 bg-white p-6 rounded-lg shadow-lg">
                <h4 class="text-xl font-bold mb-4 text-brand-primary">📋 이 여행 공유하기</h4>
                <div id="share-loader">
                    <p class="text-gray-500">공유 기능을 불러오는 중...</p>
                </div>
                <div id="share-content" class="hidden">
                    <p class="text-gray-600 mb-4">아래 링크를 복사하여 아내분께 보내주세요. 링크를 통해 접속하면 체크리스트가 실시간으로 동기화됩니다.</p>
                    <div class="flex items-center space-x-4 bg-gray-100 p-2 rounded-md">
                        <input type="text" id="share-url" readonly class="w-full bg-transparent p-2 text-gray-700">
                        <button id="copy-url-btn" class="bg-brand-accent text-white font-bold py-2 px-4 rounded hover:bg-orange-600 transition">복사</button>
                    </div>
                    <p id="copy-feedback" class="text-sm text-green-600 mt-2 h-4"></p>
                </div>
                 <div id="share-fallback" class="hidden">
                    <p class="text-gray-600 mb-2">플래너가 생성되었습니다! 이 링크를 공유하려면 아래 ID를 복사하여 현재 페이지 주소 끝에 <b>?tripId=</b> 와 함께 붙여넣어주세요.</p>
                    <div id="fallback-trip-id" class="w-full bg-gray-100 p-2 rounded-md font-mono text-center text-lg cursor-pointer"></div>
                     <p id="fallback-copy-feedback" class="text-sm text-green-600 mt-2 h-4"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg lg:col-span-2">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">실시간 공유 체크리스트</h4>
                    <div id="checklist-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                        <div id="checklist-loader" class="col-span-full text-center p-8">
                             <p class="text-gray-500">체크리스트를 불러오는 중...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">필수 서류: eTravel 등록 절차</h4>
                    <div class="space-y-4 md:space-y-0 md:flex md:items-center md:justify-between text-center">
                        <div class="flex-1"><div class="text-4xl">📄</div><p class="font-bold mt-2">1. 온라인 등록</p><p class="text-sm text-gray-500">출발 72시간 전<br>etravel.gov.ph (무료)</p></div>
                        <div class="text-2xl text-brand-secondary hidden md:block mx-4">→</div><div class="text-2xl text-brand-secondary md:hidden mx-auto transform rotate-90">↓</div>
                        <div class="flex-1"><div class="text-4xl">📱</div><p class="font-bold mt-2">2. QR 코드 저장</p><p class="text-sm text-gray-500">이메일 확인 후<br>휴대폰에 캡쳐</p></div>
                        <div class="text-2xl text-brand-secondary hidden md:block mx-4">→</div><div class="text-2xl text-brand-secondary md:hidden mx-auto transform rotate-90">↓</div>
                        <div class="flex-1"><div class="text-4xl">🛂</div><p class="font-bold mt-2">3. 입국 심사</p><p class="text-sm text-gray-500">여권과 함께 제시</p></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">결제 전략: 카드와 현금의 황금 비율</h4>
                    <div class="chart-container" style="height:250px;"><canvas id="financeChart"></canvas></div>
                </div>
            </div>
        </section>

        <section id="activities" class="mb-16 scroll-mt-24">
             <h3 class="text-3xl font-bold text-center mb-2">리조트 즐길거리 탐험</h3>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">안전한 이동: 공항 교통편 비교</h4>
                    <div class="chart-container"><canvas id="transportChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">아기 맞춤 시설 찾기</h4>
                     <div id="activity-filters" class="flex flex-wrap justify-center gap-2 mb-6">
                        <button data-filter="all" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold">전체</button>
                        <button data-filter="water" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold">💧 물놀이</button>
                        <button data-filter="play" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold">🧸 실내놀이</button>
                        <button data-filter="experience" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold">🐠 체험</button>
                    </div>
                    <div id="activity-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <section id="dining" class="mb-16 scroll-mt-24">
            <h3 class="text-3xl font-bold text-center mb-2">먹거리 가이드</h3>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-center border-b mb-6">
                    <button id="tab-resort" class="tab-button flex-1 py-2 font-semibold text-lg border-b-4 border-transparent">리조트</button>
                    <button id="tab-delivery" class="tab-button flex-1 py-2 font-semibold text-lg border-b-4 border-transparent">배달음식</button>
                </div>
                <div id="content-resort" class="tab-content"></div>
                <div id="content-delivery" class="tab-content hidden"></div>
            </div>
        </section>

        <section id="safety" class="mb-16 scroll-mt-24">
            <h3 class="text-3xl font-bold text-center mb-2">건강 & 안전 허브</h3>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">아기 건강 3대 수칙</h4>
                    <div class="flex justify-around text-center mt-4">
                        <div><div class="text-5xl mb-2">💧</div><h5 class="font-bold">안전한 물</h5></div>
                        <div><div class="text-5xl mb-2">☀️</div><h5 class="font-bold">자외선 차단</h5></div>
                        <div><div class="text-5xl mb-2">🦟</div><h5 class="font-bold">벌레 퇴치</h5></div>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h4 class="text-xl font-bold mb-4 text-brand-primary">응급 의료 지원</h4>
                    <div class="space-y-4">
                        <div class="bg-red-100 p-3 rounded-lg text-center"><p class="text-red-700 font-semibold">필리핀 긴급전화: <span class="font-bold text-2xl ml-2">911</span></p></div>
                        <div class="bg-blue-50 p-3 rounded-lg"><p class="font-bold">리조트 내 의료 지원</p></div>
                        <div class="bg-blue-50 p-3 rounded-lg"><p class="font-bold">가까운 병원</p></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="itinerary" class="scroll-mt-24">
            <h3 class="text-3xl font-bold text-center mb-2">4박 5일 추천 일정</h3>
            <div id="itinerary-accordion" class="space-y-4"></div>
        </section>
    </main>

    <footer class="bg-brand-dark text-white text-center py-6 mt-12">
        <p>가족의 모든 순간이 행복으로 채워지기를 바랍니다.</p>
    </footer>

    <script type="module">
        // --- This script will only run after the entire page is loaded ---
        console.log("[Debug] Page loaded. Starting main script.");

        // --- Static UI Rendering ---
        function renderStaticUI() {
            console.log("[Debug] Starting to render static UI elements.");
            try {
                const tooltipTitleCallback=(i)=>{const t=i[0];let e=t.chart.data.labels[t.dataIndex];return Array.isArray(e)?e.join(" "):e};new Chart(document.getElementById("financeChart").getContext("2d"),{type:"doughnut",data:{labels:["신용카드 (리조트 내)","페소 현금 (팁/배달)"],datasets:[{data:[85,15],backgroundColor:["#3498DB","#5DADE2"],borderColor:"#F8F7F4",borderWidth:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{title:tooltipTitleCallback}}}}});new Chart(document.getElementById("transportChart").getContext("2d"),{type:"bar",data:{labels:["리조트 셔틀",["프라이빗","리무진"],"일반 택시/그랩"],datasets:[{label:"안전",data:[9,10,4],backgroundColor:"#2C3E50"},{label:"편의성",data:[8,10,7],backgroundColor:"#5DADE2"},{label:"비용 효율",data:[7,3,10],backgroundColor:"#E67E22"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,max:10}},plugins:{legend:{position:"bottom"},tooltip:{callbacks:{title:tooltipTitleCallback}}}}});const e={water:[{t:"어린이 수영장 & 아쿠아 플레이",d:"안전한 수심과 그늘막, 작은 미끄럼틀이 있어 영유아에게 완벽해요."},{t:"프라이빗 비치",d:"파도가 잔잔하고 모래놀이 장난감을 무료로 빌릴 수 있어요."}],play:[{t:"토들러 존",d:"3세 이하 전용 공간! 볼풀, 미니 클라이밍 기구가 있어요."},{t:"어드벤처 존",d:"대형 슬라이드 옆 유아 공간을 이용하세요. (긴팔, 양말 필수!)"}],experience:[{t:"물고기 먹이 주기",d:"해변에서 열리는 무료 체험. 아기에게 특별한 경험을 선물하세요."},{t:"미니 골프",d:"온 가족이 함께 즐기는 가벼운 야외 활동입니다."}]},t=document.getElementById("activity-cards");for(const[a,l]of Object.entries(e))for(const e of l){const l=document.createElement("div");l.className="activity-card border p-4 rounded-lg",l.dataset.category=a,l.innerHTML=`<h5 class="font-bold">${e.t}</h5><p class="text-sm text-gray-600">${e.d}</p>`,t.appendChild(l)}const a=document.querySelectorAll(".filter-btn");a.forEach(e=>{e.addEventListener("click",()=>{a.forEach(e=>{e.classList.remove("bg-brand-primary","text-white"),e.classList.add("bg-gray-200")}),e.classList.add("bg-brand-primary","text-white"),e.classList.remove("bg-gray-200");const l=e.dataset.filter;document.querySelectorAll("#activity-cards .activity-card").forEach(e=>e.style.display="all"===l||e.dataset.category===l?"block":"none")})}),a[0].click();const l=document.getElementById("tab-resort"),n=document.getElementById("tab-delivery"),r=document.getElementById("content-resort"),o=document.getElementById("content-delivery");r.innerHTML='<h4 class="text-xl font-bold mb-4 text-center">아기와 함께 가기 좋은 레스토랑</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center"><div><h5 class="font-bold text-lg">타이즈 (Tides)</h5><p class="text-sm text-gray-600">인터내셔널 뷔페. 어린이 전용 코너와 팬케이크가 인기 만점!</p></div><div><h5 class="font-bold text-lg">아쿠아 (Acqua)</h5><p class="text-sm text-gray-600">이탈리안 레스토랑. 조용한 분위기.</p></div><div><h5 class="font-bold text-lg">부코 바 / 브리즈</h5><p class="text-sm text-gray-600">수영장 옆 캐주얼 다이닝.</p></div></div>',o.innerHTML='<h4 class="text-xl font-bold mb-4 text-center">리조트로 한식과 맥주 배달시키기</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h5 class="font-bold mb-2">한식 배달 추천</h5><ul class="list-disc list-inside text-gray-700"><li>본촌 (Bonchon)</li><li>분식 (Bunsik)</li><li>다인 (Da-In)</li></ul></div><div><h5 class="font-bold mb-2">맥주 & 간식 배달</h5><ul class="list-disc list-inside text-gray-700"><li>아씨 세시 한인마트</li><li>로빈슨 슈퍼마켓</li></ul></div></div><div class="mt-6 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded text-center"><p class="font-extrabold text-lg">⭐️ 최고의 꿀팁! ⭐️</p><p>카카오톡 ID: <span class="font-mono bg-white px-2 py-1 rounded-md">pusanmart</span></p></div>';function c(e,t,a,l){e.classList.add("active","text-brand-primary"),e.classList.remove("text-gray-500"),t.classList.remove("active","text-brand-primary"),t.classList.add("text-gray-500"),a.classList.remove("hidden"),l.classList.add("hidden")}c(l,n,r,o),l.addEventListener("click",()=>c(l,n,r,o)),n.addEventListener("click",()=>c(n,l,o,r));const i=document.getElementById("itinerary-accordion"),d=[{day:1,title:"도착 및 리조트 적응",details:["공항 도착 후 리조트 셔틀로 이동","점심 식사 후 수영장에서 휴식","해변에서 일몰 감상"]},{day:2,title:"물놀이의 세계",details:["어린이 수영장 & 아쿠아 플레이","아기 낮잠, 부모님 휴식","베이비시터 서비스 이용 후 저녁 식사"]},{day:3,title:"바다와 육지 탐험",details:["물고기 먹이주기 & 모래놀이","아기와 토들러 존 방문","배달 음식으로 편안한 저녁"]},{day:4,title:"놀이와 휴식",details:["어드벤처 존 방문 후 미니 골프","메인 수영장에서 마지막 물놀이","기념 저녁 식사"]},{day:5,title:"안녕, 세부!",details:["여유로운 마지막 아침 식사","체크아웃 후 공항 이동"]}];for(const e of d){const t=document.createElement("div");t.className="bg-white rounded-lg shadow-lg overflow-hidden",t.innerHTML=`<button class="accordion-header w-full p-4 text-left font-bold text-lg bg-brand-light flex justify-between items-center"><span>${e.day}일차: ${e.title}</span><span class="transform transition-transform duration-300">▼</span></button><div class="accordion-content p-4 border-t hidden">${e.details.map(e=>`<p>• ${e}</p>`).join("")}</div>`,i.appendChild(t)}document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.nextElementSibling.classList.toggle("hidden"),e.querySelector("span:last-child").classList.toggle("rotate-180")})});const s=document.querySelectorAll("section"),m=document.querySelectorAll("#main-nav a");window.addEventListener("scroll",()=>{let e="";s.forEach(t=>{pageYOffset>=t.offsetTop-120&&(e=t.getAttribute("id"))}),m.forEach(t=>{t.classList.remove("active"),t.getAttribute("href").includes(e)&&t.classList.add("active")})});
                console.log("[Debug] Static UI rendering complete.");
            } catch (error) {
                console.error("[Debug] Error rendering static UI:", error);
            }
        }
        
        // --- Firebase Logic Function ---
        async function initFirebase() {
            console.log("[Debug] Attempting to initialize Firebase.");
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cebu-trip-app';
            let db, auth, tripDocRef, unsubscribe;

            const checklistData = { '서류 & 금전': {'passport':'여권 & 항공권','etravel':'eTravel QR코드','money':'신용카드 & 페소 현금'},'아기 필수품':{'diapers':'기저귀 (방수/일반)','rashguard':'긴팔 래쉬가드 & 모자','clothes':'긴팔옷/양말 (어드벤처존)','toys':'애착용품 & 비상간식'},'건강 & 안전':{'sunscreen':'유아용 선크림','repellent':'벌레 퇴치제 (필수)','meds':'상비약 (해열제 등)'}};
            const defaultChecklistState = {passport:false,etravel:false,money:false,diapers:false,rashguard:false,clothes:false,toys:false,sunscreen:false,repellent:false,meds:false};

            function displayFirebaseError(message) {
                console.error(`[Debug] Firebase Error: ${message}`);
                const errorMsg = `<p class="text-red-500 font-semibold">${message}</p>`;
                document.getElementById('share-loader').innerHTML = errorMsg;
                document.getElementById('checklist-loader').innerHTML = errorMsg;
            }

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                displayFirebaseError("공유 기능을 불러올 수 없습니다. 이 기능은 특정 환경에서만 지원됩니다.");
                return;

            console.log("[Debug] Firebase config found. Initializing app...");
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("[Debug] Signing in anonymously...");
                await signInAnonymously(auth);
                onAuthStateChanged(auth, user => {
                    if (user) { 
                        console.log("[Debug] Auth state changed, user is signed in:", user.uid);
                        handleTripSession(); 
                    } else { 
                        displayFirebaseError("인증에 실패했습니다. 페이지를 새로고침 해주세요."); 
                    }
                });
            } catch (error) {
                displayFirebaseError(`초기화 중 오류 발생: ${error.message}`);
            }

            async function handleTripSession() {
                console.log("[Debug] Handling trip session...");
                const params = new URLSearchParams(window.location.search);
                let tripId = params.get('tripId');
                const collectionPath = `artifacts/${appId}/public/data/cebu-trip-checklists`;
                try {
                    let isNewUrl = false;
                    if (tripId) {
                        console.log(`[Debug] Existing tripId found: ${tripId}`);
                        tripDocRef = doc(db, collectionPath, tripId);
                    } else {
                        isNewUrl = true;
                        console.log("[Debug] No tripId found, creating new trip document...");
                        const newDocRef = await addDoc(collection(db, collectionPath), { createdAt: serverTimestamp(), checklist: defaultChecklistState });
                        tripId = newDocRef.id;
                        console.log(`[Debug] New trip document created with id: ${tripId}`);
                        tripDocRef = newDocRef;
                    }
                    
                    if(isNewUrl) {
                         try {
                            // This might fail in sandboxed environments, so we wrap it.
                            history.replaceState({}, 'Cebu Trip', `?tripId=${tripId}`);
                            document.getElementById('share-url').value = window.location.href;
                            document.getElementById('share-content').classList.remove('hidden');
                         } catch (e) {
                            console.warn("[Debug] history.replaceState failed. This is expected in some sandboxed environments.", e);
                            document.getElementById('share-fallback').classList.remove('hidden');
                            document.getElementById('fallback-trip-id').textContent = tripId;
                         }
                    } else {
                        document.getElementById('share-url').value = window.location.href;
                        document.getElementById('share-content').classList.remove('hidden');
                    }
                    
                    document.getElementById('share-loader').classList.add('hidden');

                    if (unsubscribe) unsubscribe();
                    console.log("[Debug] Setting up Firestore onSnapshot listener.");
                    unsubscribe = onSnapshot(tripDocRef, (docSnap) => {
                        console.log("[Debug] onSnapshot fired.");
                        if (docSnap.exists()) {
                            console.log("[Debug] Document data:", docSnap.data());
                            renderChecklist(docSnap.data().checklist);
                        } else {
                             console.log("[Debug] Document does not exist, creating with default state.");
                            setDoc(tripDocRef, { createdAt: serverTimestamp(), checklist: defaultChecklistState });
                        }
                    }, error => {
                        displayFirebaseError(`데이터 동기화 중 오류 발생: ${error.message}`);
                    });
                } catch (error) {
                     displayFirebaseError(`여행 정보를 불러오는 데 실패했습니다: ${error.message}`);
                }
            }
        
            function renderChecklist(data) {
                console.log("[Debug] Rendering checklist with data:", data);
                const container = document.getElementById('checklist-container');
                container.innerHTML = '';
                for (const category in checklistData) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h5 class="font-bold text-lg mb-3">${category}</h5>`;
                    const ul = document.createElement('ul');
                    ul.className = 'space-y-2';
                    for (const itemId in checklistData[category]) {
                        const itemText = checklistData[category][itemId];
                        const isChecked = data ? data[itemId] || false : false;
                        const li = document.createElement('li');
                        li.className = `checklist-item flex items-center ${isChecked ? 'checked' : ''}`;
                        li.innerHTML = `<input type="checkbox" id="${itemId}" data-id="${itemId}" class="h-4 w-4 mr-2" ${isChecked ? 'checked' : ''}><label for="${itemId}" class="cursor-pointer">${itemText}</label>`;
                        ul.appendChild(li);
                    }
                    categoryDiv.appendChild(ul);
                    container.appendChild(categoryDiv);
                }
                document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => updateChecklistInFirestore(e.target.dataset.id, e.target.checked));
                });
            }

            async function updateChecklistInFirestore(itemId, isChecked) {
                if (!tripDocRef) return;
                console.log(`[Debug] Updating Firestore: ${itemId} -> ${isChecked}`);
                try {
                    await setDoc(tripDocRef, { checklist: { [itemId]: isChecked } }, { merge: true });
                } catch (error) { console.error("Error updating checklist: ", error); }
            }
        
            document.getElementById('copy-url-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('share-url');
                urlInput.select();
                document.execCommand('copy');
                const feedback = document.getElementById('copy-feedback');
                feedback.textContent = '복사되었습니다!';
                setTimeout(() => { feedback.textContent = ''; }, 2000);
            });
            
            document.getElementById('fallback-trip-id').addEventListener('click', (e) => {
                const textToCopy = e.target.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const feedback = document.getElementById('fallback-copy-feedback');
                    feedback.textContent = 'ID가 복사되었습니다!';
                    setTimeout(() => { feedback.textContent = ''; }, 2000);
                });
            });
        }
    
        // --- Initial Load ---
        // This ensures static UI is drawn first, then Firebase is initialized.
        document.addEventListener('DOMContentLoaded', () => {
            renderStaticUI();
            initFirebase();
        });
    </script>
</body>
</html>
